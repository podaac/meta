name: Sync Iteration to TVA

on:
  schedule:
    - cron: "*/10 * * * *"   # every 10 minutes
  workflow_dispatch:

jobs:
  sync-iteration:
    runs-on: ubuntu-latest
    environment: podaac projects
    permissions:
      issues: read
      contents: read

    steps:
      - name: Sync iteration to TVA
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PROJECTS_TOKEN }}
          script: |
            const ORG = "podaac";
            const TVA_PROJECT_NUMBER = 74; // TVA project number

            const ALLOWED_SOURCE_PROJECTS = [
              "hitide-25.4",
              "SOTO PI 25.4"
            ];
            
            async function getProjectByTitle(title) {
              const query = `
                query ($org: String!) {
                  organization(login: $org) {
                    projectsV2(first: 50) {
                      nodes {
                        id
                        title
                        number
                      }
                    }
                  }
                }
              `;
              const res = await github.graphql(query, { org: ORG });
              return res.organization.projectsV2.nodes.find(p => p.title === title);
            }
            
            async function getItems(projectId) {
              const query = `
                query ($projectId: ID!) {
                  node(id: $projectId) {
                    ... on ProjectV2 {
                      items(first: 100) {               # adjust pagination if needed
                        nodes {
                          id
                          content {
                            ... on Issue {
                              id
                              title
                              number
                              repository { name }
                            }
                          }
                          fieldValues(first: 20) {
                            nodes {
                              ... on ProjectV2ItemFieldIterationValue {
                                title
                                field {
                                  ... on ProjectV2IterationField {
                                    name
                                  }
                                }
                              }
                            }
                          }
                        }
                      }
                    }
                  }
                }
              `;
              const res = await github.graphql(query, { projectId });
              return res.node.items.nodes;
            }
            
            for (const sourceName of ALLOWED_SOURCE_PROJECTS) {
              console.log(`Processing source project: ${sourceName}`);
              const sourceProject = await getProjectByTitle(sourceName);
              if (!sourceProject) continue;

              const items = await getItems(sourceProject.id);

              for (const item of items) {
                console.log(`Processing item: ${item.content.id} ${item.content.title}`);
              }

            }

            console.log("Iteration synced to TVA");